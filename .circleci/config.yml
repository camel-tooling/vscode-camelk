version: 2.1

job_default: &job_defaults
  docker:
    - image: cimg/node:lts-browsers
  
jobs:
  build:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: Setup Environment Variables
          command: |
            echo 'export HOME=/home/circleci' >> $BASH_ENV
            echo 'export CHANGE_MINIKUBE_NONE_USER=true' >> $BASH_ENV
            echo 'export MINIKUBE_WANTUPDATENOTIFICATION=false' >> $BASH_ENV
            echo 'export MINIKUBE_WANTREPORTERRORPROMPT=false' >> $BASH_ENV
            echo 'export MINIKUBE_HOME=$HOME' >> $BASH_ENV
            echo 'export CHANGE_MINIKUBE_NONE_USER=true' >> $BASH_ENV
            echo 'export KUBECONFIG=$HOME/.kube/config' >> $BASH_ENV
      - run:
          name: Install Node environment
          command: |
            curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
            sudo apt-get install -y nodejs
      - run:
          name: Configure Kamel on Minikube
          command: |     
            sudo apt-get update -y            
            sudo apt-get -qq -y install conntrack iptables 
            # Download and provide in path kubectl , which is a requirement for using minikube.
            curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.19.0/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
            # Download and provide in path minikube.
            curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.15.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/
            # Download and provide in path kamel.
            curl -Lo kamel.tar.gz https://github.com/apache/camel-k/releases/download/v1.2.0/camel-k-client-1.2.0-linux-64bit.tar.gz
            tar -zxvf kamel.tar.gz
            chmod +x kamel
            sudo mv kamel /usr/local/bin/
            echo $HOME
            mkdir -p $HOME/.kube $HOME/.minikube
            echo "Change minikube none user?"
            echo $CHANGE_MINIKUBE_NONE_USER
            echo $KUBECONFIG
            touch $KUBECONFIG
            minikube start --vm-driver=docker --kubernetes-version=v1.19.0
            echo "minikube started"
            minikube addons enable registry
            echo "minikube addons enabled"
            sudo chown -R circleci: /home/circleci/.minikube/
            kubectl cluster-info
            kamel install
            # Clean CLI which were used to start the Kubernetes instance
            sudo rm /usr/local/bin/minikube
            sudo rm /usr/local/bin/kubectl
            sudo rm /usr/local/bin/kamel                
      - run:
          name: install-vsce
          command: sudo npm install -g vsce
      - run:
          name: npm-ci
          command: npm ci
      - run:
          name: npm-vscode:prepublish
          command: npm run vscode:prepublish
      - run:
          name: vsce-package
          command: vsce package
      - run:
          name: test
          command: npm test
      - run:
          name: test UI
          command: npm run ui-test
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
      - store_artifacts:
          path: /home/circleci/.config/Code/logs
      - store_artifacts:
          path: /home/circleci/.config/Code/User/workspaceStorage/
  sonar:
    <<: *job_defaults
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: install-typescript
          command: sudo npm install -g typescript
      - run:
          name: npm-ci
          command: npm ci
      - sonarcloud/scan
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm

orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.2

workflows:
  version: 2
  vscode-camelk:
    jobs:
      - build
      - sonar:
          context: sonarcloud
          filters:
            branches:
              only:
                - master
          requires:
            - build
